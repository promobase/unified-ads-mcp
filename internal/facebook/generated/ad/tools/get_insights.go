// Code generated by codegen. DO NOT EDIT.

package tools

import (
	"context"
	"encoding/json"
	"fmt"
	"strings"

	"unified-ads-mcp/internal/facebook/generated/common"

	"github.com/mark3labs/mcp-go/mcp"
	"github.com/mark3labs/mcp-go/server"
)

// ad_get_insightsArgs defines the typed arguments for ad_get_insights
type ad_get_insightsArgs struct {
	ID                           string                   `json:"id" jsonschema:"required,description=Ad ID,pattern=^[0-9]+$"`
	Fields                       []string                 `json:"fields,omitempty" jsonschema:"description=Fields to return"`
	Limit                        int                      `json:"limit,omitempty" jsonschema:"description=Maximum number of results,minimum=1,maximum=100"`
	After                        string                   `json:"after,omitempty" jsonschema:"description=Cursor for pagination (next page)"`
	Before                       string                   `json:"before,omitempty" jsonschema:"description=Cursor for pagination (previous page)"`
	ActionAttributionWindows     []string                 `json:"action_attribution_windows,omitempty" jsonschema:"description=Action Attribution Windows"`
	ActionBreakdowns             []string                 `json:"action_breakdowns,omitempty" jsonschema:"description=Action Breakdowns"`
	ActionReportTime             string                   `json:"action_report_time,omitempty" jsonschema:"description=Action Report Time"`
	Breakdowns                   []string                 `json:"breakdowns,omitempty" jsonschema:"description=Breakdowns"`
	DatePreset                   string                   `json:"date_preset,omitempty" jsonschema:"description=Date Preset"`
	DefaultSummary               bool                     `json:"default_summary,omitempty" jsonschema:"description=Default Summary"`
	ExportColumns                []string                 `json:"export_columns,omitempty" jsonschema:"description=Export Columns"`
	ExportFormat                 string                   `json:"export_format,omitempty" jsonschema:"description=Export Format"`
	ExportName                   string                   `json:"export_name,omitempty" jsonschema:"description=Export Name"`
	Filtering                    []map[string]interface{} `json:"filtering,omitempty" jsonschema:"description=Filtering"`
	Level                        string                   `json:"level,omitempty" jsonschema:"description=Level"`
	ProductIdLimit               int                      `json:"product_id_limit,omitempty" jsonschema:"description=Product ID Limit,pattern=^[0-9]+$"`
	Sort                         []string                 `json:"sort,omitempty" jsonschema:"description=Sort"`
	Summary                      []string                 `json:"summary,omitempty" jsonschema:"description=Summary"`
	SummaryActionBreakdowns      []string                 `json:"summary_action_breakdowns,omitempty" jsonschema:"description=Summary Action Breakdowns"`
	TimeIncrement                string                   `json:"time_increment,omitempty" jsonschema:"description=Time Increment"`
	TimeRange                    map[string]interface{}   `json:"time_range,omitempty" jsonschema:"description=Time Range"`
	TimeRanges                   []map[string]interface{} `json:"time_ranges,omitempty" jsonschema:"description=Time Ranges"`
	UseAccountAttributionSetting bool                     `json:"use_account_attribution_setting,omitempty" jsonschema:"description=Use Account Attribution Setting"`
	UseUnifiedAttributionSetting bool                     `json:"use_unified_attribution_setting,omitempty" jsonschema:"description=Use Unified Attribution Setting"`
}

// RegisterAdGetInsightsHandler registers the ad_get_insights tool
func RegisterAdGetInsightsHandler(s *server.MCPServer) error {
	tool := mcp.NewToolWithRawSchema(
		"ad_get_insights",
		"List insights for this Ad Returns AdsInsights.",
		json.RawMessage(`{"additionalProperties":false,"properties":{"action_attribution_windows":{"description":"Action Attribution Windows","items":{"type":"string"},"type":"array"},"action_breakdowns":{"description":"Action Breakdowns","items":{"type":"string"},"type":"array"},"action_report_time":{"description":"Action Report Time (enum: adgroupinsights_action_report_time_enum_param)","enum":["conversion","impression","lifetime","mixed"],"type":"string"},"after":{"description":"Cursor for pagination (next page)","type":"string"},"before":{"description":"Cursor for pagination (previous page)","type":"string"},"breakdowns":{"description":"Breakdowns","items":{"type":"string"},"type":"array"},"date_preset":{"description":"Date Preset (enum: adgroupinsights_date_preset_enum_param)","enum":["data_maximum","last_14d","last_28d","last_30d","last_3d","last_7d","last_90d","last_month","last_quarter","last_week_mon_sun","last_week_sun_sat","last_year","maximum","this_month","this_quarter","this_week_mon_today","this_week_sun_today","this_year","today","yesterday"],"type":"string"},"default_summary":{"description":"Default Summary","type":"boolean"},"export_columns":{"description":"Export Columns","items":{"type":"string"},"type":"array"},"export_format":{"description":"Export Format","type":"string"},"export_name":{"description":"Export Name","type":"string"},"fields":{"description":"Fields to return","items":{"type":"string"},"type":"array"},"filtering":{"description":"Filtering","items":{"additionalProperties":true,"type":"object"},"type":"array"},"id":{"description":"Ad ID","pattern":"^[0-9]+$","type":"string"},"level":{"description":"Level (enum: adgroupinsights_level_enum_param)","enum":["account","ad","adset","campaign"],"type":"string"},"limit":{"description":"Maximum number of results","maximum":100,"minimum":1,"type":"integer"},"product_id_limit":{"description":"Product ID Limit","pattern":"^[0-9]+$","type":"integer"},"sort":{"description":"Sort","items":{"type":"string"},"type":"array"},"summary":{"description":"Summary","items":{"type":"string"},"type":"array"},"summary_action_breakdowns":{"description":"Summary Action Breakdowns","items":{"type":"string"},"type":"array"},"time_increment":{"description":"Time Increment","type":"string"},"time_range":{"description":"Time Range","type":"string"},"time_ranges":{"description":"Time Ranges","items":{"additionalProperties":true,"type":"object"},"type":"array"},"use_account_attribution_setting":{"description":"Use Account Attribution Setting","type":"boolean"},"use_unified_attribution_setting":{"description":"Use Unified Attribution Setting","type":"boolean"}},"required":["id"],"type":"object"}`),
	)

	s.AddTool(tool, AdGetInsightsHandler)
	return nil
}

// AdGetInsightsHandler handles the ad_get_insights tool
func AdGetInsightsHandler(ctx context.Context, request mcp.CallToolRequest) (*mcp.CallToolResult, error) {
	var args ad_get_insightsArgs
	if err := request.BindArguments(&args); err != nil {
		return common.HandleBindError(err)
	}
	endpoint := fmt.Sprintf("/%s/insights", args.ID)
	// Prepare query parameters
	params := make(map[string]string)
	// ID is part of path, not query params
	if len(args.Fields) > 0 {
		params["fields"] = strings.Join(args.Fields, ",")
	}
	if args.Limit > 0 {
		params["limit"] = fmt.Sprintf("%d", args.Limit)
	}
	if args.After != "" {
		params["after"] = args.After
	}
	if args.Before != "" {
		params["before"] = args.Before
	}
	if len(args.ActionAttributionWindows) > 0 {
		params["action_attribution_windows"] = strings.Join(args.ActionAttributionWindows, ",")
	}
	if len(args.ActionBreakdowns) > 0 {
		params["action_breakdowns"] = strings.Join(args.ActionBreakdowns, ",")
	}
	if args.ActionReportTime != "" {
		params["action_report_time"] = args.ActionReportTime
	}
	if len(args.Breakdowns) > 0 {
		params["breakdowns"] = strings.Join(args.Breakdowns, ",")
	}
	if args.DatePreset != "" {
		params["date_preset"] = args.DatePreset
	}
	params["default_summary"] = fmt.Sprintf("%v", args.DefaultSummary)
	if len(args.ExportColumns) > 0 {
		params["export_columns"] = strings.Join(args.ExportColumns, ",")
	}
	if args.ExportFormat != "" {
		params["export_format"] = args.ExportFormat
	}
	if args.ExportName != "" {
		params["export_name"] = args.ExportName
	}
	// TODO: Handle []map[string]interface{} for Filtering
	if args.Level != "" {
		params["level"] = args.Level
	}
	if args.ProductIdLimit > 0 {
		params["product_id_limit"] = fmt.Sprintf("%d", args.ProductIdLimit)
	}
	if len(args.Sort) > 0 {
		params["sort"] = strings.Join(args.Sort, ",")
	}
	if len(args.Summary) > 0 {
		params["summary"] = strings.Join(args.Summary, ",")
	}
	if len(args.SummaryActionBreakdowns) > 0 {
		params["summary_action_breakdowns"] = strings.Join(args.SummaryActionBreakdowns, ",")
	}
	if args.TimeIncrement != "" {
		params["time_increment"] = args.TimeIncrement
	}
	// TODO: Handle map[string]interface{} for TimeRange
	// TODO: Handle []map[string]interface{} for TimeRanges
	params["use_account_attribution_setting"] = fmt.Sprintf("%v", args.UseAccountAttributionSetting)
	params["use_unified_attribution_setting"] = fmt.Sprintf("%v", args.UseUnifiedAttributionSetting)

	result, err := common.MakeGraphAPIRequest(ctx, "GET", endpoint, params, nil)

	if err != nil {
		return common.HandleAPIError(err)
	}

	return &mcp.CallToolResult{
		Content: []mcp.Content{
			mcp.NewTextContent(string(result)),
		},
	}, nil
}
